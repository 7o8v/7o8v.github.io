<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Javascript engine exploit 1 | 7o8v&#39;s blog</title>
  <meta name="keywords" content=" Browser , JavascriptEngine , JavascriptCore , Webkit ">
  <meta name="description" content="Javascript engine exploit 1 | 7o8v&#39;s blog">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="Syclover Binary security researcher 成都信息工程大学">
<meta name="keywords" content="binary">
<meta property="og:type" content="website">
<meta property="og:title" content="About 7o8v">
<meta property="og:url" content="http:&#x2F;&#x2F;www.7o8v.me&#x2F;about&#x2F;index.html">
<meta property="og:site_name" content="7o8v&#39;s blog">
<meta property="og:description" content="Syclover Binary security researcher 成都信息工程大学">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-10-30T06:51:10.899Z">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/sublime.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1" ></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.0.1" ></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value="">
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>7o8v</span>
</div>

<div class="icon">
    
        
        <a title="github" href="https://github.com/joshua7o8v" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
        <a title="email" href="mailto:269134615@qq.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active">全部文章<small>(5)</small></div></li>
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/about">关于</a><a style="width: 50%"  class="friends">友链</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="5">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://redteam.today/">cl0und</a></li>
            
            <li><a target="_blank" href="https://evoa.me/">evoa</a></li>
            
            <li><a target="_blank" href="http://kkdlong.win/">kkdlong</a></li>
            
            <li><a target="_blank" href="https://blog.l0ca1.xyz/">l0ca1</a></li>
            
            <li><a target="_blank" href="http://abcdefghijklmnopqrst.xyz/">骑麦兜看落日</a></li>
            
            <li><a target="_blank" href="https://0xpoker.cn">0xpoker</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode==13){return false;}">
        <input class="search" type="text" placeholder="以 in: 开头进行全文搜索" autocomplete="off"id="local-search-input" >
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">Browser</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">JavascriptEngine</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">Chrome</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">V8</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">JavascriptCore</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">Webkit</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        <a  class=""
           href="/2019/10/30/35C3-CTF-krautflare-exploit/"
           data-tag="Browser,JavascriptEngine,Chrome,V8"
           data-author="" >
            <span class="post-title" title="35C3 CTF krautflare exploit">35C3 CTF krautflare exploit</span>
            <span class="post-date" title="2019-10-30 19:33:13">2019/10/30</span>
        </a>
        
        <a  class=""
           href="/2019/10/30/Javascript-engine-exploit-3/"
           data-tag="Browser,JavascriptEngine,JavascriptCore,Webkit"
           data-author="" >
            <span class="post-title" title="Javascript engine exploit 3">Javascript engine exploit 3</span>
            <span class="post-date" title="2019-10-30 15:49:10">2019/10/30</span>
        </a>
        
        <a  class=""
           href="/2019/10/30/Javascript-engine-exploit-1/"
           data-tag="Browser,JavascriptEngine,JavascriptCore,Webkit"
           data-author="" >
            <span class="post-title" title="Javascript engine exploit 1">Javascript engine exploit 1</span>
            <span class="post-date" title="2019-10-30 14:19:27">2019/10/30</span>
        </a>
        
        <a  class=""
           href="/2019/10/30/Javascript-engine-exploit-2/"
           data-tag="Browser,JavascriptEngine,JavascriptCore,Webkit"
           data-author="" >
            <span class="post-title" title="Javascript engine exploit 2">Javascript engine exploit 2</span>
            <span class="post-date" title="2019-10-30 15:49:07">2019/10/30</span>
        </a>
        
        <a  class=""
           href="/2019/10/30/V8%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"
           data-tag="Browser,JavascriptEngine,Chrome,V8"
           data-author="" >
            <span class="post-title" title="V8调试环境搭建">V8调试环境搭建</span>
            <span class="post-date" title="2019-10-30 18:36:34">2019/10/30</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-Javascript-engine-exploit-1" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Javascript engine exploit 1</h1>
    
    <div class="article-meta">
        
        
        
        
        <span class="tag">
            
            <a href="javascript:" class="color3">Browser</a>
            
            <a href="javascript:" class="color2">JavascriptEngine</a>
            
            <a href="javascript:" class="color5">JavascriptCore</a>
            
            <a href="javascript:" class="color2">Webkit</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2019-10-30 15:58:46'>2019-10-30 14:19</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-前言"><span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-JS引擎的一些基础知识"><span class="toc-text">0x01 JS引擎的一些基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JavaScript-engine-overview"><span class="toc-text">JavaScript engine overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#The-VM-Values-and-NaN-boxing"><span class="toc-text">The VM, Values, and NaN-boxing</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Objects-and-Arrays"><span class="toc-text">Objects and Arrays</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Functions"><span class="toc-text">Functions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#The-Structures"><span class="toc-text">The Structures</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Just-In-Time-compiler"><span class="toc-text">Just-In-Time compiler</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#LLInt"><span class="toc-text">LLInt</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Baseline-JIT-compiler"><span class="toc-text">Baseline JIT compiler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DFG-JIT"><span class="toc-text">DFG JIT</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#FTL-JIT"><span class="toc-text">FTL JIT</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-搭建调试环境"><span class="toc-text">0x02 搭建调试环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-开始调试"><span class="toc-text">0x03 开始调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-Reference"><span class="toc-text">0x04 Reference</span></a></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://www.anquanke.com/post/id/183804" target="_blank" rel="noopener">首发于安全客：https://www.anquanke.com/post/id/183804</a></p>
<h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>写这篇文章的目的主要是希望记录下自己学习的过程，也将自己的学习经历分享给希望学习JS引擎漏洞利用的初学者。</p>
<p>我刚开始学习的是JSC（JavaScriptCore），这是Safari浏览器所使用的内核WebKit的JS引擎。我选择这个目标入手的原因主要是这个比较简单，很多大佬给出的JS引擎的研究难度基本都是：</p>
<p>V8（Chrome）&gt; Spidermonkey（Firefox）&gt; JacaScriptCore（Safari）&gt; Chakra（Edge）</p>
<p>因为Chakra快被微软抛弃了，所以我还是选择了JSC。</p>
<h3 id="0x01-JS引擎的一些基础知识"><a href="#0x01-JS引擎的一些基础知识" class="headerlink" title="0x01 JS引擎的一些基础知识"></a>0x01 JS引擎的一些基础知识</h3><p>在学习JS引擎的漏洞利用之前，对JS引擎的一些内部运行原理做一个了解肯定是必要的。当然，也不必把所有原理都了解，由于我是通过调试特定的漏洞来进行学习（大部分初学者都是如此），所以我们只需要了解到与这个漏洞相关的一些知识就足够了。推荐去看saelo在2016年发的paper：<a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="noopener">Attacking javascript engines</a></p>
<p>我在下面也引述文章中的部分内容。</p>
<h4 id="JavaScript-engine-overview"><a href="#JavaScript-engine-overview" class="headerlink" title="JavaScript engine overview"></a>JavaScript engine overview</h4><p>总体来看，JavaScript引擎包括了三个部分：</p>
<ul>
<li>一个基础的编译器，至少需要包含一个JIT（Just-in-time）。</li>
<li>一个JavaScript VM，用来运行JavaScript代码。</li>
<li>一个JavaScript Runtime，用来提供一些内置Objects和Functions。</li>
</ul>
<p>我们不需要关心编译器的内部原理，因为跟我们的漏洞利用关系不大（至少看起来关系不大），我们只需要把编译器看作一个 “输入源码，输出字节码”的黑盒就行了。</p>
<h4 id="The-VM-Values-and-NaN-boxing"><a href="#The-VM-Values-and-NaN-boxing" class="headerlink" title="The VM, Values, and NaN-boxing"></a>The VM, Values, and NaN-boxing</h4><p>VM通常都包含一个可以直接执行字节码的解释器。VM被实现为<code>stack-based</code>的机器（相对于<code>register-based</code>来讲），从而可以通过栈来对值进行操作。对于具体的操作码的实现可能看起来和下面一样：</p>
<pre><code class="c">CASE(JSOP_ADD)
{
  MutableHandleValue lval = REGS.stackHandleAt(-2);
  MutableHandleValue rval = REGS.stackHandleAt(-1);
  MutableHandleValue res = REGS.stackHandleAt(-2);
  if (!AddOperation(cx, lval, rval, res))
    goto error;
  REGS.sp--;
}
END_CASE(JSOP_ADD)</code></pre>
<p>这段代码截取自Firefox的JS引擎Spidermonkey，而JSC使用汇编实现的类似功能，看起来就没有上面这么直观。对JSC的实现感兴趣的可以去看这个文件<code>Webkit/Source/JavaScriptCore/llint/LowLevelInterpreter64.asm</code>。</p>
<p>通常初级JIT（first stage JIT or called baseline JIT）负责减轻一些解释器的调度开销，而高级JIT（higher stage JIT）则会做一些比较复杂的优化操作。有点类似于我们平常所使用的AOT（ahead-of-time）编译器，就比如gcc。优化型JIT（也就是前面提到的高级JIT）通常都是推测型的，意思就是它们会基于一些推测来进行优化，比如它会认为一个变量是而且一直是数字类型。当然这种推测也可能出错，当遇到出错的时候JIT就会回退到推测之前的状态。</p>
<p>JavaScript是动态类型语言，因此类型信息与运行时的变量有关，而不是编译时的变量。JavaScript类型系统定义了几个元类型（number, string, boolean, null, undefined, symbol）和对象（array, function）。需要注意的是JavaScript没有像其他语言一样包含‘类’的概念。取而代之的是JavaScript使用了所谓“基于原型的继承（prototype-based-inheritance）”，每个对象都有一个指向<code>prototype</code>对象的引用，这个prototype对象包含了指向它的对象的属性。</p>
<p>出于性能考虑（快速拷贝，适应64位的寄存器架构等），所有主流的JavaScript引擎在表示一个Value的时候都不超过八字节。一些JS引擎，比如v8，会使用<code>tagged pointers</code>来表示值，它会使用最低有效位来标识一个值是指针还是立即数。JSC和Spidermonkey则使用了另一种叫做<code>NaN-boxing</code>的概念。在<code>NaN-boxing</code>中使用了多种位模式来表示NaN（Not-a-Number），所以可以将这些位模式来编码其他的值，以下是IEEE 754的规则总结：</p>
<table>
<thead>
<tr>
<th>形式</th>
<th>指数</th>
<th>小数部分</th>
</tr>
</thead>
<tbody><tr>
<td>零</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>非规约形式</td>
<td>0</td>
<td>大于0小于1</td>
</tr>
<tr>
<td>规约形式</td>
<td>1到2^{e}-2</td>
<td>大于等于1小于2</td>
</tr>
<tr>
<td>无穷</td>
<td>2^{e}-1</td>
<td>0</td>
</tr>
<tr>
<td>NaN</td>
<td>2^{e}-1</td>
<td>非0</td>
</tr>
</tbody></table>
<p>这些多余的位模式足够用来编码整型和指针了，也因为使用了NaN-boxing，对于64位平台而言，目前只有48位用于寻址。</p>
<p>JSC使用的这个方案在<code>Webkit/Source/JavaScriptCore/runtime/JSCJSValue.h</code>中有很好的解释，引用如下：</p>
<pre><code class="c">            /*
      ...
      * The top 16-bits denote the type of the encoded JSValue:
      *
      *     Pointer {  0000:PPPP:PPPP:PPPP
      *              / 0001:****:****:****
      *     Double  {         ...
      *              \ FFFE:****:****:****
      *     Integer {  FFFF:0000:IIII:IIII
      *
      * The scheme we have implemented encodes double precision values by
      * performing a 64-bit integer addition of the value 2^48 to the number.
      * After this manipulation no encoded double-precision value will begin
      * with the pattern 0x0000 or 0xFFFF. Values must be decoded by
      * reversing this operation before subsequent floating point operations
      * may be performed.
      *
      * 32-bit signed integers are marked with the 16-bit tag 0xFFFF.
      *
      * The tag 0x0000 denotes a pointer, or another form of tagged
      * immediate. Boolean, null and undefined values are represented by
      * specific, invalid pointer values:
      *
      *     False:     0x06
      *     True:      0x07
      *     Undefined: 0x0a
      *     Null:      0x02
      *
      ...
      */</code></pre>
<p>总结：</p>
<ul>
<li>Pointer：[0000][xxxx:xxxx:xxxx]（前两个字节为0，后六个字节寻址）</li>
<li>Double：[0001～FFFE][xxxx:xxxx:xxxx]</li>
<li>Intger：[FFFF][0000:xxxx:xxxx]（只有低四个字节表示数字）</li>
<li>False：[0000:0000:0000:0006]</li>
<li>True：[0000:0000:0000:0007]</li>
<li>Undefined：[0000:0000:0000:000a]</li>
<li>Null：[0000:0000:0000:0002]</li>
</ul>
<p>有意思的是0x0不是一个合法的JSValue，它会在在引擎中导致崩溃。</p>
<h4 id="Objects-and-Arrays"><a href="#Objects-and-Arrays" class="headerlink" title="Objects and Arrays"></a>Objects and Arrays</h4><p>JavaScript中的对象实际上就是属性的集合，这些属性都可用（key, value）的键值对来表示。可以使用点（foo.bar）或者方括号（foo[‘bar’]）来访问属性。至少在理论上，在使用键来查找值之前都需要先将键转化为字符串的形式。</p>
<p>数组被描述为特殊的(“exotic”)对象，如果属性名称由32位整数来表示的话，这些属性也被称为元素。如今的大多数引擎都将这个概念扩展到了所有对象。然后，数组就是拥有<code>length</code>属性的特殊对象，它的值始终等于最高元素的索引加一。这些规定的结果就是，每个对象都具有通过字符串或者符号键访问的属性，以及通过整数索引访问的属性。</p>
<p>在内部，JSC将属性和元素存储在同一片内存区域中，并且在对象内部存放指向这块内存的指针。这个指针指向这片内存的中间位置，左边存放对象的属性值，右边存放对象的元素值，而在左边最近的那个内存单元存放了一个header，这个header里包含了<code>length</code>的值。这样的内存表现形式被称为<code>Butterfly</code>，在下文我们都将这种内存和指向它的指针都称为<code>Butterfly</code>，这样会使文章理解起来轻松一些。</p>
<pre><code class="c">--------------------------------------------------------
.. | propY | propX | length | elem0 | elem1 | elem2 | ..
--------------------------------------------------------
                            ^
                            |
            +---------------+
            |
  +-------------+
  | Some Object |
  +-------------+</code></pre>
<p>实际上使用Butterfly来存储数据只是一个可选项（Optional），如果对象属性不多（不大于6个）而且不是数组的时候，对象的属性值将不会申请Butterfly，而是存储在对象内部，内存结构如下：</p>
<pre><code class="shell">object            :    objectHeader    butterfly(Null)
object+0x10    :    prop_1                prop_2
object+0x20    :    prop_3                prop_4
object+0x30    : prop_5                prop_6</code></pre>
<p>虽然通常来讲，元素不需要线性地存储在内存中，但特别地：</p>
<pre><code class="c">a = [];
a[0] = 42;
a[10000] = 42;</code></pre>
<p>这段代码可能会导致数组以某种分散的模式来存储，这种模式会根据给定的索引额外在数组的后备存储内存中映射一个索引出来。这样的话，这个数组就不需要请求10001个元素所需要的内存了。除了不同的数组存储模式，数组也拥有不同的表现形式来表示存储的数据。举个例子，一个32位的整型数组可能会以原生形式（native form）存储来避免NaN-boxing的解包和重打包操作，这样也节约了内存。因此JSC也在<code>Webkit/Source/JavaScriptCore/runtime/IndexingType.h</code>中定义了一组不同的索引类型。最重要的部分有：</p>
<pre><code>    ArrayWithInt32      = IsArray | Int32Shape;
    ArrayWithDouble     = IsArray | DoubleShape;
    ArrayWithContiguous = IsArray | ContiguousShape;</code></pre><p>第三种存储的是JSValue，前两种存储的都是它们的原生类型。</p>
<p>到这里可能有读者会好奇在这种模式下，对象的属性是如何被索引到的，这点将会在后面深入讨论，简单来讲，有一种被称为<code>structure</code>的特殊元对象通过给定的属性名，将每个对象的属性映射到对应内存位置。</p>
<h4 id="Functions"><a href="#Functions" class="headerlink" title="Functions"></a>Functions</h4><p>Functions在Javascript十分重要，因此它也值得我们对它进行特别的讨论。</p>
<p>当执行一个函数体时，两个特殊的变量将可以访问。一个是<code>arguments</code>，它提供对参数和调用者的访问，从而使得可以创建具有参数的Function。另一个就是<code>this</code>，根据Function的调用情况，<code>this</code>可以指向不同的对象：</p>
<ul>
<li>如果调用的Function作为构造函数（ new func(…) ），<code>this</code>指向新创建的对象，在Function定义期间，构造函数就已经为新对象设置了<code>.prototype</code>属性。</li>
<li>如果Function作为某个对象的方法被调用（obj.func(…)），<code>this</code>将指向这个对象。</li>
<li>否则<code>this</code>只是指向当前的全局对象，因为它在Function之外使用。</li>
</ul>
<p>因为Functions是JavaScript中十分重要的对象，它们同样具有属性。根据刚才的描述我们知道了<code>.prototype</code>属性，另外每个Function（实际上是Function prototype）还有两个比较有趣的属性，<code>.call</code>和<code>.apply</code>函数，允许使用给定的<code>this</code>和一些参数来调用Function。例如，可以使用它们来完成装饰器的功能：</p>
<pre><code class="javascript">function decorate(func) {
    return function() {
        for (var i = 0; i &lt; arguments.length; i++) {
            // do something with arguments[i]
        }
        return func.apply(this, arguments);
    };
}</code></pre>
<p>这同样也对Function在JS引擎的内部实现有一定的影响，这个导致了Function不能假定调用它们的对象的类型，因为这些对象可能是任意类型，因此所有的JavaScript内部Funciton不仅要检查参数的类型，也要对<code>this</code>对象进行类型检查。</p>
<p>在内部，内置的函数或者方法通常以两种方法实现，C++的Native Function或者是JavaScript Function。可以看一个JSC中的Native Function示例，<code>Math.pow()</code>的实现：</p>
<pre><code class="c"> EncodedJSValue JSC_HOST_CALL mathProtoFuncPow(ExecState* exec){
   // ECMA 15.8.2.1.13
   double arg = exec-&gt;argument(0).toNumber(exec);
   double arg2 = exec-&gt;argument(1).toNumber(exec);
   return JSValue::encode(JSValue(operationMathPow(arg, arg2)));
 }</code></pre>
<p>我们可以看到：</p>
<ol>
<li>Native JavaScript Function的签名。</li>
<li>如何使用<code>argument</code>提取参数（如果参数不够就返回undefine）。</li>
<li>如何将参数转化为需要的类型，有一组特定的转换规则，这一点将在之后详细讨论。</li>
<li>如何对本地数据类型进行实际操作。</li>
<li>如何将结果返回给调用者，这里简单地将结果编码为了JSValue。</li>
</ol>
<p>这里还有一个显而易见的部分，各种核心的操作(<code>operationMathPow(arg, arg2)</code>)都是用单独的函数，这样它们可以直接被JIT编译了的代码调用。</p>
<h4 id="The-Structures"><a href="#The-Structures" class="headerlink" title="The Structures"></a>The Structures</h4><p>这个部分属于JavaScript对象模型的内容，关系到JavaScript引擎如何去访问对象的属性。因为访问属性在JavaScript中是一个十分频繁的操作，为了提高访问速度，每个主流的JavaScript引擎都对此做了优化，在不同的引擎中对这种技术的称呼也各不相同：</p>
<ul>
<li>在学术论文中被称为 <em>Hidden Classes</em></li>
<li>在V8中是 <em>Maps</em></li>
<li>在Chakra中是 <em>Types</em></li>
<li>在JavaScriptCore中是 <em>Structures</em></li>
<li>在Spidermonkey中是 <em>Shapes</em></li>
</ul>
<p>根据ECMAScript的规范，所有JavaScript对象都被定义为一个由字符串键值映射到属性值的一个字典。引用MDN的描述：</p>
<blockquote>
<p>An object is a collection of properties, and a property is an association between a name (or <em>key</em>) and a value.</p>
</blockquote>
<p>既然如此，作为键值的字符串如果存储在对象的内存中将会十分浪费空间，因为这样的话每生成一个对象就出多出一份键值的拷贝。而在JavaScript中，多个对象具有相同的属性是经常发生的事情，从某个方面来讲，这些对象都具有相同的形状（Shapes），也可以说具有相同的结构（Structure）。比如：</p>
<pre><code class="javascript">const object1 = { x: 1, y: 2 };
const object2 = { x: 3, y: 4 };
</code></pre>
<p><code>object1</code>和<code>object2</code>虽然是两个不同的对象，但是他们的键值都是一样的。这种情况下它们就具有相同的结构，在JavaScriptCore中也能看到它们具有相同的StructureID。</p>
<pre><code class="shell">&gt;&gt;&gt; describe(object1)
Object: 0x106ab0100 with butterfly 0x0 (Structure 0x106a500e0:[Object, {x:0, y:1}, NonArray, Proto:0x106ab4000, Leaf]), StructureID: 289
&gt;&gt;&gt; describe(object2)
Object: 0x106ab0140 with butterfly 0x0 (Structure 0x106a500e0:[Object, {x:0, y:1}, NonArray, Proto:0x106ab4000, Leaf]), StructureID: 289
&gt;&gt;&gt;
</code></pre>
<p>如果我们要访问对象的属性，JSC就会先根据StructureID找到对应的Structure，然后找到对应的属性名，读取属性在内联存储或者是butterfly中的偏移值，最后读取属性值。</p>
<p>如果此时给<code>object2</code>增加一个属性<code>z</code>，JavaScriptCore就会在Structure链中寻找有没有只拥有<code>x,y,z</code>三个属性的Structure，如果没有则重新创建一个并分配一个新的StructureID。</p>
<pre><code class="shell">&gt;&gt;&gt; objectY.z = 0
0
&gt;&gt;&gt; describe(objectY)
Object: 0x106ab0140 with butterfly 0x0 (Structure 0x106a50150:[Object, {x:0, y:1, z:2}, NonArray, Proto:0x106ab4000, Leaf]), StructureID: 290
&gt;&gt;&gt;
</code></pre>
<h4 id="Just-In-Time-compiler"><a href="#Just-In-Time-compiler" class="headerlink" title="Just-In-Time compiler"></a>Just-In-Time compiler</h4><p>前面提到过JIT，但没有细说。其实JIT也是一个编译器，可以简单理解为和gcc一样的编译器，不过JS引擎中的JIT是将JavaScript代码编译成了机器码。JIT在JSC中一共分为四个等级：</p>
<ol>
<li>LLInt (LowLevelInterpreter)</li>
<li>Baseline JIT compiler</li>
<li>DFG JIT</li>
<li>FTL JIT</li>
</ol>
<h5 id="LLInt"><a href="#LLInt" class="headerlink" title="LLInt"></a>LLInt</h5><p>llint是JavaScriptCore虚拟机的基础组件，逻辑非常简单，可以理解为一个switch循环，传入对应的JavaScript机器码，然后执行对应的指令。</p>
<h5 id="Baseline-JIT-compiler"><a href="#Baseline-JIT-compiler" class="headerlink" title="Baseline JIT compiler"></a>Baseline JIT compiler</h5><p>当一个function被多次调用之后，它就会变得”hot”，这时候就需要使用JIT compiler对它进行优化。在<code>Source/JavaScriptCore/jit/JIT.cpp</code>中：</p>
<blockquote>
<p><em>// We can only do this optimization because we execute ProgramCodeBlock’s exactly once.</em></p>
<p>// This optimization would be invalid otherwise. When the LLInt determines it wants to*</p>
<p><em>// do OSR entry into the baseline JIT in a loop, it will pass in the bytecode offset it</em></p>
<p><em>// was executing at when it kicked off our compilation. We only need to compile code for</em></p>
<p><em>// anything reachable from that bytecode offset.</em></p>
</blockquote>
<p>当function需要进一步优化的时候，JSC就会通过OSR（On Stack Replacement ）从LLInt切换到Baseline JIT。</p>
<h5 id="DFG-JIT"><a href="#DFG-JIT" class="headerlink" title="DFG JIT"></a>DFG JIT</h5><p>引用WebKit官方文档<a href="https://webkit.org/blog/3362/introducing-the-webkit-ftl-jit/" target="_blank" rel="noopener">WebKit JIT</a>中的一段话：</p>
<blockquote>
<p>The first execution of any function always starts in the interpreter tier. As soon as any statement in the function executes more than 100 times, or the function is called more than 6 times (whichever comes first), execution is diverted into code compiled by the Baseline JIT. This eliminates some of the interpreter’s overhead but lacks any serious compiler optimizations. Once any statement executes more than 1000 times in Baseline code, or the Baseline function is invoked more than 66 times, we divert execution again to the DFG JIT.</p>
</blockquote>
<p>和前面从LLInt切换到Baseline JIT的条件类似，如果一个函数在Baseline JIT中执行次数过多，又会切换到DFG JIT中。</p>
<p>从文档中还可以看到一个关于DFG的细节：</p>
<blockquote>
<p>The DFG starts by converting bytecode into the DFG CPS form, which reveals data flow relationships between variables and temporaries. Then profiling information is used to infer guesses about types, and those guesses are used to insert a minimal set of type checks. Traditional compiler optimizations follow. The compiler finishes by generating machine code directly from the DFG CPS form.</p>
</blockquote>
<p>DFG会根据搜集到的信息去推测变量的类型，如果认定了一个变量的类型，在之后将不会对变量类型进行检查，这个对我们之后的利用会很有帮助。</p>
<h5 id="FTL-JIT"><a href="#FTL-JIT" class="headerlink" title="FTL JIT"></a>FTL JIT</h5><blockquote>
<p>We reuse most of the DFG phases including its CPS-based optimizations. The new FTL pipeline is a drop-in replacement for the third-tier DFG backend. It involves additional JavaScript-aware optimizations over DFG SSA form, followed by a phase that lowers DFG IR (<em>intermediate representation</em>) to LLVM IR. We then invoke LLVM’s optimization pipeline and LLVM’s MCJIT backend to generate machine code.</p>
</blockquote>
<p>其实FTL相对于其他三个JIT算是新加入的一个技术，设计它的目的是想让JavsScript的运行更加接近C的速度，事实证明确实非常接近了。值得一提的是FTL重用了DFG的一些部分，包括类型推理引擎。</p>
<h3 id="0x02-搭建调试环境"><a href="#0x02-搭建调试环境" class="headerlink" title="0x02 搭建调试环境"></a>0x02 搭建调试环境</h3><p>官方文档：<a href="https://webkit.org/building-webkit/" target="_blank" rel="noopener">Building Webkit</a></p>
<p>我使用的系统是MacOS，不过WebKit同样可以在其他系统（Windows、Linux）编译运行，我看到大多数人会选择在Ubuntu 18.04上编译，不过我没编译成功过，不知道什么原因。我直接引用别人在Ubuntu 18.04的编译命令：</p>
<pre><code class="shell"># sudo apt install libicu-dev python ruby bison flex cmake build-essential ninja-build git gperf
$ git clone git://git.webkit.org/WebKit.git &amp;&amp; cd WebKit
$ Tools/gtk/install-dependencies
$ Tools/Scripts/build-webkit --jsc-only --debug
$ cd WebKitBuild/Debug
$ LD_LIBRARY_PATH=./lib bin/jsc
</code></pre>
<p>我说一下在MacOS的build流程。首先确保安装了Xcode和Xcode的命令行工具。</p>
<pre><code class="bash">#我的系统版本 macOS Mojave
$ sw_vers
ProductName:    Mac OS X
ProductVersion:    10.14.6
BuildVersion:    18G84

$ git clone git://git.webkit.org/WebKit.git WebKit

#这个说明已经安装好了
$ xcode-select --install
xcode-select: error: command line tools are already installed, use &quot;Software Update&quot; to install updates

#确定Xcode路径是否正确
$ xcode-select -p
/Applications/Xcode.app/Contents/Developer

#Xcode路径和上面不一样的，可以是用如下命令切换
$ sudo xcode-select --s /Applications/Xcode.app/Contents/Developer

$ xcodebuild -version
Xcode 10.3
Build version 10G8

#编译之前确定切换到漏洞分支
$ git checkout ...
#到WebKit根目录下执行这个指令就可以了
$ Tools/Scripts/build-webkit --jsc-only --debug

</code></pre>
<p>我可能运气比较好，到这里都没出现过什么问题。直接可以运行JSC的<em>REPL</em>(Read Eval Print Loop)。</p>
<pre><code class="shell">$ WebKitBuild/Debug/bin/jsc
&gt;&gt;&gt; a = 1
1
&gt;&gt;&gt;
</code></pre>
<p>如果遇到<code>DYLD_FRAMEWORK_PATH</code>路径的问题可以手动设置一下环境变量：</p>
<pre><code class="shell">#补全为绝对路径就行了
export DYLD_FRAMEWORK_PATH=.../WebKitBuild/Debug
</code></pre>
<p>调试器我用的lldb，对比gdb的指令可以很快上手：<a href="https://lldb.llvm.org/use/map.html" target="_blank" rel="noopener">GDB to LLDB command map</a></p>
<h3 id="0x03-开始调试"><a href="#0x03-开始调试" class="headerlink" title="0x03 开始调试"></a>0x03 开始调试</h3><p>可以直接用lldb载入jsc：</p>
<pre><code class="bash">$ lldb ./WebKitBuild/Debug/bin/jsc
(lldb) target create &quot;./WebKitBuild/Debug/bin/jsc&quot;
Current executable set to &#39;./WebKitBuild/Debug/bin/jsc&#39; (x86_64).
(lldb) run
Process 39132 launched: &#39;/Users/7o8v/Documents/SecResearch/Browser/WebKit/WebKit.git/WebKitBuild/Debug/bin/jsc&#39; (x86_64)
&gt;&gt;&gt;
</code></pre>
<p>调试过程中可以配合JSC提供的调试函数进行调试，比如<code>describe()</code>：</p>
<pre><code class="bash">&gt;&gt;&gt; a = [1,2,3]
1,2,3
&gt;&gt;&gt; describe(a)
Object: 0x108ab4340 with butterfly 0x8000e4008 (Structure 0x108af2a00:[Array, {}, ArrayWithInt32, Proto:0x108ac80a0, Leaf]), StructureID: 97
&gt;&gt;&gt; a[3] = 1.1
1.1
&gt;&gt;&gt; describe(a)
Object: 0x108ab4340 with butterfly 0x8000e4008 (Structure 0x108af2a70:[Array, {}, ArrayWithDouble, Proto:0x108ac80a0, Leaf]), StructureID: 98
&gt;&gt;&gt; a[4] = {}
[object Object]
&gt;&gt;&gt; describe(a)
Object: 0x108ab4340 with butterfly 0x8000e4008 (Structure 0x108af2ae0:[Array, {}, ArrayWithContiguous, Proto:0x108ac80a0]), StructureID: 99
&gt;&gt;&gt;
</code></pre>
<p>更多的调试技巧可以看这篇文章：<a href="http://dwfault-blog.imwork.net:30916/2019/01/03/WebKit%20JavaScriptCore%E7%9A%84%E7%89%B9%E6%AE%8A%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7/" target="_blank" rel="noopener">WebKit JavaScriptCore的特殊调试技巧</a></p>
<p>过程中也可以使用<code>Ctrl+C</code>中断，然后使用lldb命令。</p>
<p>也可以载入JSC之后，运行脚本文件：</p>
<pre><code class="bash">$ lldb ./WebKitBuild/Debug/bin/jsc
(lldb) target create &quot;./WebKitBuild/Debug/bin/jsc&quot;
Current executable set to &#39;./WebKitBuild/Debug/bin/jsc&#39; (x86_64).
(lldb) run -i ./poc.js
Process 39152 launched: ...
&gt;&gt;&gt;
</code></pre>
<h3 id="0x04-Reference"><a href="#0x04-Reference" class="headerlink" title="0x04 Reference"></a>0x04 Reference</h3><p>[1] <a href="https://github.com/m1ghtym0/browser-pwn#safari-webkit" target="_blank" rel="noopener">https://github.com/m1ghtym0/browser-pwn#safari-webkit</a></p>
<p>[2] <a href="https://webkit.org/blog/6756/es6-feature-complete/" target="_blank" rel="noopener">https://webkit.org/blog/6756/es6-feature-complete/</a></p>
<p>[3] <a href="https://mathiasbynens.be/notes/shapes-ics" target="_blank" rel="noopener">https://mathiasbynens.be/notes/shapes-ics</a></p>
<p>[4] <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Working_with_Objects" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Working_with_Objects</a></p>
<p>[5] <a href="https://webkit.org/blog/3362/introducing-the-webkit-ftl-jit/" target="_blank" rel="noopener">https://webkit.org/blog/3362/introducing-the-webkit-ftl-jit/</a></p>
<p>[6] <a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="noopener">http://phrack.org/papers/attacking_javascript_engines.html</a></p>
<p>[7] <a href="http://dwfault-blog.imwork.net:30916/2019/01/03/WebKit%20JavaScriptCore%E7%9A%84%E7%89%B9%E6%AE%8A%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7/" target="_blank" rel="noopener">http://dwfault-blog.imwork.net:30916/2019/01/03/WebKit%20JavaScriptCore%E7%9A%84%E7%89%B9%E6%AE%8A%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7/</a></p>
<p>[8] <a href="https://webkit.org/blog/7846/concurrent-javascript-it-can-work/" target="_blank" rel="noopener">https://webkit.org/blog/7846/concurrent-javascript-it-can-work/</a></p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎联系作者指出任何有错误或不够清晰的表达。 </span>
    </div>
</article>



<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>Javascript engine exploit 1</p>
    
    <p><span class="copy-title">本文作者:</span><a href="javascript:void(0)" title="7o8v">7o8v</a></p>
    <p><span class="copy-title">发布时间:</span>2019-10-30, 14:19:27</p>
    <p><span class="copy-title">最后更新:</span>2019-10-30, 15:58:46</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/2019/10/30/Javascript-engine-exploit-1/" title="Javascript engine exploit 1">http://www.7o8v.me/2019/10/30/Javascript-engine-exploit-1/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>





    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<input type="hidden" id="MathJax-js"
        value="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</input>
    




    </div>
    <div class="copyright">
        <p class="footer-entry">©2019-2020 7o8v</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" href="javascript:void(0)"></a>
    </div>
</div>
<div class="acParent"></div>

</body>
<script src="/js/jquery.pjax.js?v=1.0.1" ></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#Browser','#JavascriptEngine','#Chrome','#V8','#JavascriptCore','#Webkit',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
        .nav .hide-list.fullscreen {
            left: 492px
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
